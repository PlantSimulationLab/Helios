<!-- HTML header for doxygen 1.12.0-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.13.2"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Helios: Solar Position Plugin Documentation</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<script type="text/javascript" src="doxygen-awesome-darkmode-toggle.js"></script>
<script type="text/javascript" src="doxygen-awesome-paragraph_link.js"></script>
<script type="text/javascript" src="doxygen-awesome-tabs.js"></script>
<script type="text/javascript" src="doxygen-awesome-interactive-toc.js"></script>
<script type="text/javascript">
  DoxygenAwesomeDarkModeToggle.init()
  DoxygenAwesomeParagraphLink.init()
  DoxygenAwesomeTabs.init()
  DoxygenAwesomeInteractiveToc.init()
</script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
  $(function() { init_search(); });
/* @license-end */
</script>
<script type="text/javascript">
window.MathJax = {
  options: {
    ignoreHtmlClass: 'tex2jax_ignore',
    processHtmlClass: 'tex2jax_process'
  }
};
</script>
<script type="text/javascript" id="MathJax-script" async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome-sidebar-only-darkmode-toggle.css" rel="stylesheet" type="text/css"/>
</head>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-93BB4673PE"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-93BB4673PE');
</script>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-3F0Y5Z6543"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-3F0Y5Z6543');
</script>
<body>
<script>
    try {
        // Remove the stored “last visited page” so the tree always starts fresh
        localStorage.removeItem('navpath');
        // Older Doxygen versions might use this key:
        localStorage.removeItem('nav-sync-path');
        // Force panel synchronization on by default
        localStorage.setItem('navsync', 'true');
        // (fallback for some older builds)
        localStorage.setItem('nav-sync', 'true');
    } catch(e) {
        /* storage unavailable? ignore */
    }
</script>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="5">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="Helios_logo_small.png"></td>
  <td id="projectalign">
   <div id="projectname">
       <span id="projectnumber">&#160;v1.3.33</span>
   </div>
  </td>
    <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <span id="MSearchSelect"                onmouseover="return searchBox.OnSearchSelectShow()"                onmouseout="return searchBox.OnSearchSelectHide()">&#160;</span>
          <input type="text" id="MSearchField" value="" placeholder="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.svg" alt=""/></a>
          </span>
        </div>
</td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.13.2 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(0); });
/* @license-end */
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('_solar_position_doc.html',''); initResizable(true); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Solar Position Plugin Documentation</div></div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul>
  <li class="level1">
    <a href="#SolarIntro">Introduction</a>
  </li>
  <li class="level1">
    <a href="#SolarConstructor">SolarPosition Class Constructor</a>
  </li>
  <li class="level1">
    <a href="#SolarTheory">Model Theory</a>
    <ul>
      <li class="level2">
        <a href="#SolarPosTheory">Position of the Sun</a>
      </li>
      <li class="level2">
        <a href="#SolarFluxTheory">Direct and Diffuse Solar Flux</a>
      </li>
      <li class="level2">
        <a href="#LWTheory">Ambient Longwave Flux</a>
      </li>
    </ul>
  </li>
  <li class="level1">
    <a href="#SolarLib">Using the SolarPosition Plug-in</a>
    <ul>
      <li class="level2">
        <a href="#SolarPos">Getting the Direction of the Sun</a>
      </li>
      <li class="level2">
        <a href="#SolarFlux">Getting the Solar Flux</a>
        <ul>
          <li class="level3">
            <a href="#SolarFluxTurb">Calibrating the turbidity using weather station (radiometer) data</a>
          </li>
          <li class="level3">
            <a href="#SolarFluxClouds">Incorporating the effects of clouds</a>
          </li>
        </ul>
      </li>
      <li class="level2">
        <a href="#LWFlux">Getting the Sky Longwave Flux</a>
      </li>
    </ul>
  </li>
</ul>
</div>
<div class="textblock"><p><br  />
<br  />
 </p>
<table class="doxtable">
<tr>
<th>Dependencies</th><td>None. </td></tr>
<tr>
<th>CMakeLists.txt</th><td>set( PLUGINS "solarposition" ) </td></tr>
<tr>
<th>Header File</th><td>include "SolarPosition.h" </td></tr>
<tr>
<th>Class</th><td><a class="el" href="class_solar_position.html">SolarPosition</a> </td></tr>
</table>
<h1><a class="anchor" id="SolarIntro"></a>
Introduction</h1>
<p>This plugin calculates the position of the sun, and also implements other models for solar fluxes as well as longwave fluxes from the sky. Model theory and equations are given in the sections below.</p>
<h1><a class="anchor" id="SolarConstructor"></a>
SolarPosition Class Constructor</h1>
<table class="doxtable">
<tr>
<th>Constructors </th></tr>
<tr>
<td><a class="el" href="class_solar_position.html#a25fa8345e4101fa2d63757ca1bc9fe10">SolarPosition( helios::Context* context)</a> </td></tr>
<tr>
<td>SolarPosition( int UTC, float latitude, float longitude, helios::Context* context) </td></tr>
</table>
<p>The <a class="el" href="class_solar_position.html">SolarPosition</a> class can be initialized by simply passing a pointer to the Helios context as an argument to the constructor. This gives the class the model access to the time and date currently set in the Context. The model must also know certain parameters about the simulated location, in particular the offset from UTC time, latitude, and longitude. A description of these parameters are given in the table below. These can be supplied using the second constructor listed in the table above. If the Context is the only argument supplied to the constructor, default values are assumed for UTC, latitude, and longitude (see table below).</p>
<table class="doxtable">
<caption>\ref SolarPosition constructor inputs</caption>
<tr>
<th>Input Parameter</th><th>Description</th><th>Convention</th><th>Default Behavior </th></tr>
<tr>
<td>UTC</td><td>Difference in hours between Coordinated Universal Time (UTC) for a particular location. See the figure below to determine a particular UTC offset.</td><td>UTC offset value is positive moving West.</td><td>+8:00 </td></tr>
<tr>
<td>latitude</td><td>Geographic coordinate that specifies the north–south position of a point on the Earth's surface in degrees.</td><td>Latitude is positive in the northern hemisphere.</td><td>+38.55 </td></tr>
<tr>
<td>longitude</td><td>Geographic coordinate that specifies the east-west position of a point on the Earth's surface in degrees.</td><td>Longitude is positive in the western hemisphere.</td><td>+121.76 </td></tr>
</table>
<div class="image">
<img src="1200px-Standard_World_Time_Zones.png" alt=""/>
</div>
<h1><a class="anchor" id="SolarTheory"></a>
Model Theory</h1>
<h2><a class="anchor" id="SolarPosTheory"></a>
Position of the Sun</h2>
<p>The solar position model was implemented following the description in <a href="https://www.sciencedirect.com/science/article/pii/B9780123737502500069">Chapter 1 of Iqbal (1983)</a>.</p>
<p>The day angle \(\Gamma\) given as the polar angle of the earth relative to the sun ( \(\Gamma=0\) on Jan. 1) is calculated as</p>
<center> \(\Gamma = 2\pi(DOY-1)/365.25\), (1) </center><p>where DOY is the <a href="https://en.wikipedia.org/wiki/Julian_day">Julian Day</a> of the year.</p>
<p>The solar declination angle is then calculated as</p>
<center> \(\delta = 0.006918 - 0.399912\,\mathrm{cos}(\Gamma) + 0.070257\,\mathrm{sin}(\Gamma)- 0.006758\,\mathrm{cos}(2\Gamma) + 0.000907\,\mathrm{sin}(2\Gamma) - 0.002697\,\mathrm{cos}(3\Gamma) + 0.00148\,\mathrm{sin}(3\Gamma)\). (2) </center><p>The <a href="https://en.wikipedia.org/wiki/Equation_of_time">equation of time</a> is calculated as</p>
<center> \(EoT = 229.18(0.000075 + 0.001868\,\mathrm{cos}(\Gamma) - 0.032077\,\mathrm{sin}(\Gamma) - 0.014615\,\mathrm{cos}(2\Gamma) - 0.04089\,\mathrm{sin}(2\Gamma))\), (3) </center><p>The hour angle is given by</p>
<center> \(h=15(LST-12)\), (4) </center><p>with</p>
<center> \(LST=hour+minute/60+TC/60\), (5) </center><p>and</p>
<center> \(TC=4(15UTC-longitude)+EoT\), (6) </center><p>Finally, the solar elevation angle is given by</p>
<center> \(\theta_s=\mathrm{sin}^{-1}( \mathrm{sin}(latitude)\mathrm{sin}(\delta) + \mathrm{cos}(latitude)\mathrm{cos}(\delta)\mathrm{cos}(h) )\), (7) </center><p>and the solar azimuthal angle is given by</p>
<center> \(\phi_s=\mathrm{cos}^{-1}( (\mathrm{sin}(\delta) - \mathrm{sin}(\theta_s)\mathrm{sin}(latitude))/(\mathrm{cos}(\theta)\mathrm{cos}(latitude)))\). (8) </center><p>Note that \(\mathrm{cos}^{-1}\) gives angles between 0 and \(\pi\), so to get a \(\phi_s\) between 0 and \(2\pi\), we take \(\phi_s=2\pi-\phi_s\) if \(LST&gt;12\).</p>
<h2><a class="anchor" id="SolarFluxTheory"></a>
Direct and Diffuse Solar Flux</h2>
<p>Clear-sky solar fluxes are calculated using the 'REST-2' model of <a href="https://www.sciencedirect.com/science/article/pii/S0038092X07000990">Gueymard (2008)</a>. REST-2 is a state-of-the-art atmospheric transmission model that calculates the solar flux at Earth's surface after attenuation by water vapor, CO<sub>2</sub>, Ozone, NO<sub>2</sub>, and aerosols. The model partitions the total radiative flux into direct and diffuse components.</p>
<h2><a class="anchor" id="LWTheory"></a>
Ambient Longwave Flux</h2>
<p>The longwave radiation flux emanating from the clear-sky is modeled following <a href="https://rmets.onlinelibrary.wiley.com/doi/full/10.1002/qj.49712253306">Prata (1996)</a>.</p>
<p>The model surmounts to calculating the effective emissivity of the sky as a function of precipitable water in the atmosphere</p>
<center> \(\epsilon_s = 1-(1+u)\mathrm{exp}\left(-\left(1.2+3u\right)^{0.5}\right)\), </center><p>where \(u\) is the wator vapor path length (cm of precipitable water) which can be estimated following <a href="https://journals.ametsoc.org/doi/abs/10.1175/1520-0450(1981)020%3C0003%3ATRBTPW%3E2.0.CO%3B2">Viswanadham (1981)</a> for example.</p>
<p>The downwelling longwave radiation flux on a horizontal surface is given by</p>
<center> \(R_L=\epsilon_s\sigma T_a^4\), </center><p>where \(\sigma=5.67\times10^{-8}\) W/m<sup>2</sup>-K<sup>4</sup>, and \(T_a\) is the air temperature in Kelvin measured near the ground (say 2 m height).</p>
<h1><a class="anchor" id="SolarLib"></a>
Using the SolarPosition Plug-in</h1>
<h2><a class="anchor" id="SolarPos"></a>
Getting the Direction of the Sun</h2>
<p>The direction of the sun can be queried in one of several ways: a Cartesian unit vector pointing in the direction of the sun, a spherical coordinate describing the direction of the sun, the elevation angle of the sun, the zenithal angle of the sun, and the azimuthal angle of the sun. The functions to query these quantities are given in the table below. Each of these functions calculates the solar direction based on the current time and date set in the Context (see <a class="el" href="classhelios_1_1_context.html#ae3d9e19581787775556b8dd7dc1ac845">setTime()</a> and <a class="el" href="classhelios_1_1_context.html#a5b9565e477a321ec7b7b9b62d43b2139">setDate()</a>), and the UTC, latitude, and longitude specified in the <a class="el" href="class_solar_position.html">SolarPosition</a> constructor.</p>
<table class="doxtable">
<tr>
<th>Direction Quantity</th><th>Function </th></tr>
<tr>
<td>Unit vector pointing toward the sun.</td><td><a class="el" href="class_solar_position.html#af889756d5b3d7d3c366887fae1fb86ab">SolarPosition::getSunDirectionVector()</a> </td></tr>
<tr>
<td>Spherical coordinate vector pointing toward the sun.</td><td><a class="el" href="class_solar_position.html#adad5310db742ef9f2754e75095aeea92">SolarPosition::getSunDirectionSpherical()</a> </td></tr>
<tr>
<td>Elevation angle of the sun (radians).</td><td><a class="el" href="class_solar_position.html#a307e963d840abb9ee7867579fec69fa2">SolarPosition::getSunElevation()</a> </td></tr>
<tr>
<td>Zenithal angle of the sun (radians).</td><td><a class="el" href="class_solar_position.html#a4c4ba4931d13c6cc2ad69e8eab90ac14">SolarPosition::getSunZenith()</a> </td></tr>
<tr>
<td>Azimuthal angle of the sun (radians).</td><td><a class="el" href="class_solar_position.html#a2b736578f75ecb8532556931b8263dc4">SolarPosition::getSunAzimuth()</a> </td></tr>
</table>
<p>Below is an example of how to use the <a class="el" href="class_solar_position.html">SolarPosition</a> mode to calculate the sun angle.</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &quot;SolarPosition&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span> main(){</div>
<div class="line">    Context context; <span class="comment">//declare the context</span></div>
<div class="line"> </div>
<div class="line">    <span class="comment">//Set the current time and date</span></div>
<div class="line">    context.setDate(1,5,2015); <span class="comment">//May 1, 2015</span></div>
<div class="line">    context.setTime(30,12); <span class="comment">//12:30</span></div>
<div class="line"> </div>
<div class="line">    <span class="comment">//Initialize the SolarPosition class</span></div>
<div class="line">    <a class="code hl_class" href="class_solar_position.html">SolarPosition</a> sun( 7, 31.256, 119.947, &amp;context );</div>
<div class="line"> </div>
<div class="line">    <span class="comment">//Get the sun position</span></div>
<div class="line">    vec3 direction = sun.getSunDirectionVector(); <span class="comment">//unit vector</span></div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">float</span> elevation = sun.getSunElevation(); <span class="comment">//elevation angle (radians)</span></div>
<div class="line">    <span class="keywordtype">float</span> azimuth = sun.getSunAzimuth(); <span class="comment">//azimuthal angle (radians)</span></div>
<div class="line">    </div>
<div class="line">}</div>
</div><!-- fragment --><h2><a class="anchor" id="SolarFlux"></a>
Getting the Solar Flux</h2>
<p>The solar flux can be calculated using the REST-2 model of <a href="https://www.sciencedirect.com/science/article/pii/S0038092X07000990?casa_token=BAJYGez71awAAAAA:CfmA4oT9MLiHGvpD6oUkkDu4EJ1S9uRabZq4-wM07jtcmviZ12jvhD8VVcAkjLWoGNMtg8hDaqo">Gueymard (2008)</a> using the <a class="el" href="class_solar_position.html#a9701cb29a0336a11c445d285405b6956">SolarPosition::getSolarFlux()</a> function. IT IS CRITICAL TO NOTE THAT THE CALCULATED FLUX IS FOR A SURFACE PERPENDICULAR TO THE SUN DIRECTION. To get the flux on a horizontal surface, multiply by the cosine of the solar zenith angle.</p>
<p>Methods are available to get the incoming solar radiation flux perpendicular to the direction of the sun 1) for the entire solar spectrum (<a class="el" href="class_solar_position.html#a9701cb29a0336a11c445d285405b6956">SolarPosition::getSolarFlux()</a>), 2) for the PAR band (<a class="el" href="class_solar_position.html#a5c6635160944b5b8202ea9965da6de9d">SolarPosition::getSolarFluxPAR()</a>), and 3) (<a class="el" href="class_solar_position.html#a611461f700df9efa7c56b6f4ee7712b7">SolarPosition::getSolarFluxNIR()</a>).</p>
<p>These functions takes several arguments needed for the model, which are listed in the table below.</p>
<table class="doxtable">
<tr>
<th>Argument</th><th>Description</th><th>Example Value </th></tr>
<tr>
<td>pressure</td><td>Atmospheric pressure in Pascals (near the ground).</td><td>101,000 Pa </td></tr>
<tr>
<td>temperature</td><td>Air temperature in Kelvin (near the ground).</td><td>300 K </td></tr>
<tr>
<td>humidity</td><td>Air relative humidity (near the ground).</td><td>0.6 </td></tr>
<tr>
<td>turbidity</td><td>Angstrom's aerosol turbidity coefficient.</td><td>0.05 </td></tr>
</table>
<p>The very similar function <a class="el" href="class_solar_position.html#af8dbd15453ce775dab5b2c5a49b1c93b">SolarPosition::getDiffuseFraction()</a> calculates the fraction of the total flux that is diffuse. The fraction that is direct is simply one minus the diffuse fraction. This function takes the same arguments as <a class="el" href="class_solar_position.html#a9701cb29a0336a11c445d285405b6956">SolarPosition::getSolarFlux()</a>.</p>
<p>Example code for using these solar flux functions is given below.</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &quot;SolarPosition&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span> main(){</div>
<div class="line">    Context context; <span class="comment">//declare the context</span></div>
<div class="line"> </div>
<div class="line">    <span class="comment">//Set the current time and date</span></div>
<div class="line">    context.setDate(1,5,2015); <span class="comment">//May 1, 2015</span></div>
<div class="line">    context.setTime(30,12); <span class="comment">//12:30</span></div>
<div class="line"> </div>
<div class="line">    <span class="comment">//Initialize the SolarPosition class</span></div>
<div class="line">    <a class="code hl_class" href="class_solar_position.html">SolarPosition</a> sun( 7, 31.256, 119.947, &amp;context );</div>
<div class="line"> </div>
<div class="line">    <span class="comment">//Get the sun position</span></div>
<div class="line">    <span class="keywordtype">float</span> zenith = sun.getSunZenith(); <span class="comment">//zenithal angle (radians)</span></div>
<div class="line"> </div>
<div class="line">    <span class="comment">//Calculate solar flux</span></div>
<div class="line">    <span class="keywordtype">float</span> <a class="code hl_variable" href="_energy_balance_model_8h.html#a247aeeed35717bee85fc2540c3591fd3" title="Gas constant, J mol⁻¹ K⁻¹">R</a> = sun.getSolarFlux( 101000, 300, 0.6, 0.05 ); <span class="comment">//flux perpendicular to sun (W/m^2)</span></div>
<div class="line">    <span class="keywordtype">float</span> R_horiz = <a class="code hl_variable" href="_energy_balance_model_8h.html#a247aeeed35717bee85fc2540c3591fd3" title="Gas constant, J mol⁻¹ K⁻¹">R</a>*cos(zenith);  <span class="comment">//flux on horizontal surface</span></div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">float</span> f_diff = sun.getDiffuseFraction( 101000, 300, 0.6, 0.05 ); <span class="comment">//fraction of diffuse radiation</span></div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">float</span> R_dir = <a class="code hl_variable" href="_energy_balance_model_8h.html#a247aeeed35717bee85fc2540c3591fd3" title="Gas constant, J mol⁻¹ K⁻¹">R</a>*(1.f-f_diff); <span class="comment">//direct component of flux (W/m^2)</span></div>
<div class="line">    </div>
<div class="line">}</div>
</div><!-- fragment --><h3><a class="anchor" id="SolarFluxTurb"></a>
Calibrating the turbidity using weather station (radiometer) data</h3>
<p>The predicted solar flux may not perfectly match local predicted solar fluxes due to uncertainty in the local turbidity value. There is a built-in routine to calibrate the turbidity based on measured radiative fluxes.</p>
<p>For the calibration, you must load radiation flux data into a timeseries within the Context. There must be at least one clear-sky day in the timeseries data, and the radiative fluxes must be for the entire solar spectrum in units of W/m<sup>2</sup>. You can then use the <a class="el" href="class_solar_position.html#aeefa73ede0d1797f94fd4ca2739f7f3e">SolarPosition::calibrateTurbidityFromTimeseries()</a> method. This method takes one argument, which is a string corresponding to the timeseries variable name containing the radiation flux data.</p>
<h3><a class="anchor" id="SolarFluxClouds"></a>
Incorporating the effects of clouds</h3>
<p>The REST2 model for solar fluxes was developed for clear-sky conditions and cannot directly be used when clouds are present. If incident solar radiation data is available (e.g., from a weather station), this can be used to calibrate the model to account for the possible presence of clouds. A simple model is described below for doing so.</p>
<p>Consider \(R_{meas,h}\) to be the measured all-wave incoming solar radiation flux on a horizontal plane (clear or cloudy conditions), and \(R_{clear}\) to be the predicted all-wave incoming solar radiation flux predicted by the REST2 model for clear-sky conditions perpendicular to the direction of the sun. This flux can be projected onto the horizontal plane according to</p>
<p class="formulaDsp">
\[    R_{clear,h} = R_{clear}\mathrm{cos}\,\theta_s.
\]
</p>
<p>The diffuse fraction can be approximated as</p>
<p class="formulaDsp">
\[    f_{diff} = 1-\frac{R_{meas,h} - R_{clear,h}}{R_{clear,h}},
\]
</p>
<p>where it is enforced that \(0\leq f_{diff} \leq 1\). The resulting flux that is output from the model is (flux perpendicular to the sun)</p>
<p class="formulaDsp">
\[   R_{model} = R_{clear}\frac{R_{meas,h}}{R_{clear,h}}.
\]
</p>
<p>In order to enable flux calibration for cloudy conditions, you must 1) Load timeseries data into the Context containing the measured all-wave solar radiation flux. This data must cover the entire period of the simulation. 2) Call <a class="el" href="class_solar_position.html#abee2003c22cbbffb671e8e6a9305b66f">SolarPosition::enableCloudCalibration()</a>, which requires a string corresponding to the timeseries data value reference in (1). Below is a code example:</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &quot;SolarPosition&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span> main(){</div>
<div class="line">   Context context; <span class="comment">//declare the context</span></div>
<div class="line"> </div>
<div class="line">   <span class="comment">//Load radiation flux timeseries data from CSV file</span></div>
<div class="line">   <span class="comment">//assume that weatherdatafile.txt has columns given in the argument below, and has a mixture of clear-sky and cloudy days</span></div>
<div class="line">   context.loadTabularTimeseriesData( <span class="stringliteral">&quot;/path/to/weatherdatafile.txt&quot;</span>, {<span class="stringliteral">&quot;Date&quot;</span>,<span class="stringliteral">&quot;Hour&quot;</span>,<span class="stringliteral">&quot;R_tot_Wm2&quot;</span>,<span class="stringliteral">&quot;Tair_C&quot;</span>,<span class="stringliteral">&quot;humidity_rel&quot;</span>,<span class="stringliteral">&quot;Patm_Pa&quot;</span>}, <span class="stringliteral">&quot;,&quot;</span>, <span class="stringliteral">&quot;YYYYMMDD&quot;</span>, 1 );</div>
<div class="line"> </div>
<div class="line">   <span class="comment">//Initialize the SolarPosition class</span></div>
<div class="line">   <a class="code hl_class" href="class_solar_position.html">SolarPosition</a> sun( 7, 31.256, 119.947, &amp;context );</div>
<div class="line"> </div>
<div class="line">   <span class="comment">//Enable cloud calibration</span></div>
<div class="line">   sun.enableCloudCalibration( <span class="stringliteral">&quot;R_tot_Wm2&quot;</span> ); <span class="comment">//reference &quot;R_tot_Wm2&quot; data field in timeseries</span></div>
<div class="line"> </div>
<div class="line">   <span class="comment">//Calibrate the clear-sky turbidity</span></div>
<div class="line">   <span class="keywordtype">float</span> turbidity = sun.calibrateTurbidityFromTimeseries( <span class="stringliteral">&quot;R_tot_Wm2&quot;</span> ); <span class="comment">//must have some clear-sky days in the weather data</span></div>
<div class="line"> </div>
<div class="line">   <span class="comment">//Loop over time</span></div>
<div class="line">   <span class="keywordflow">for</span>( <span class="keywordtype">int</span> t=0; t&lt;context.getTimeseriesLength(); t++ ){</div>
<div class="line">       context.setCurrentTimeseriesPoint( <span class="stringliteral">&quot;R_tot_Wm2&quot;</span>, t );</div>
<div class="line"> </div>
<div class="line">       <span class="keywordtype">float</span> Tair_K = context.queryTimeseriesData( <span class="stringliteral">&quot;Tair_C&quot;</span> ) + 273;</div>
<div class="line">       <span class="keywordtype">float</span> humidity_rel = context.queryTimeseriesData( <span class="stringliteral">&quot;humidity_rel&quot;</span> );</div>
<div class="line">       <span class="keywordtype">float</span> Patm_Pa = context.queryTimeseriesData( <span class="stringliteral">&quot;Patm_Pa&quot;</span> );</div>
<div class="line"> </div>
<div class="line">       <span class="comment">//Calculate solar flux</span></div>
<div class="line">       <span class="keywordtype">float</span> <a class="code hl_variable" href="_energy_balance_model_8h.html#a247aeeed35717bee85fc2540c3591fd3" title="Gas constant, J mol⁻¹ K⁻¹">R</a> = sun.getSolarFlux( Patm_Pa, Tair_K, humidity_rel, turbidity ); <span class="comment">//flux perpendicular to sun (W/m^2)</span></div>
<div class="line"> </div>
<div class="line">       <span class="keywordtype">float</span> f_diff = sun.getDiffuseFraction( Patm_Pa, Tair_K, humidity_rel, turbidity ); <span class="comment">//fraction of diffuse radiation</span></div>
<div class="line"> </div>
<div class="line">       <span class="keywordtype">float</span> R_dir = <a class="code hl_variable" href="_energy_balance_model_8h.html#a247aeeed35717bee85fc2540c3591fd3" title="Gas constant, J mol⁻¹ K⁻¹">R</a>*(1.f-f_diff); <span class="comment">//direct component of flux (W/m^2)</span></div>
<div class="line">       <span class="keywordtype">float</span> R_diff = <a class="code hl_variable" href="_energy_balance_model_8h.html#a247aeeed35717bee85fc2540c3591fd3" title="Gas constant, J mol⁻¹ K⁻¹">R</a>*f_diff; <span class="comment">//diffuse component of flux (W/m^2)</span></div>
<div class="line"> </div>
<div class="line">   }</div>
<div class="line">}</div>
</div><!-- fragment --><p>An example of the above model applied to actual direct-diffuse partitioned radiation data using a shadowband radiometer is shown below. It should be emphasized that the above model is a relatively simple approximation that produces reasonable fluxes, but more accurate predictions are possible and require much more complicated models.</p>
<div class="image">
<img src="CloudyFluxPartitioning.png" alt=""/>
</div>
<h2><a class="anchor" id="LWFlux"></a>
Getting the Sky Longwave Flux</h2>
<p>The downwelling longwave radiation flux from the sky can be calculated using the <a class="el" href="class_solar_position.html#a30ee555eedece8b7e19855877a74da71">SolarPosition::getAmbientLongwaveFlux()</a> function. This function takes the air temperature and humidity as arguments, which are defined in the same was as for the <a class="el" href="class_solar_position.html#a9701cb29a0336a11c445d285405b6956">SolarPosition::getSolarFlux()</a> function described above. The value returned by the function is the clear-sky downwelling longwave radiation flux on a horizontal surface in W/m<sup>2</sup>. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.13.2 </li>
  </ul>
</div>
</body>
</html>
