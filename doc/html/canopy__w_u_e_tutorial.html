<!-- HTML header for doxygen 1.12.0-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.13.2"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Helios: Tutorial 12: Water-use efficiency (photosyntheses per unit transpiration) for a canopy of spherical crowns</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<script type="text/javascript" src="doxygen-awesome-darkmode-toggle.js"></script>
<script type="text/javascript" src="doxygen-awesome-paragraph_link.js"></script>
<script type="text/javascript" src="doxygen-awesome-tabs.js"></script>
<script type="text/javascript" src="doxygen-awesome-interactive-toc.js"></script>
<script type="text/javascript">
  DoxygenAwesomeDarkModeToggle.init()
  DoxygenAwesomeParagraphLink.init()
  DoxygenAwesomeTabs.init()
  DoxygenAwesomeInteractiveToc.init()
</script>
<script>
    try {
        // Remove the stored “last visited page” so the tree always starts fresh
        Cookie.eraseSetting('navpath');
        localStorage.removeItem('navpath');
        // Older Doxygen versions might use this key:
        localStorage.removeItem('nav-sync-path');
        // Force panel synchronization on by default
        localStorage.setItem('navsync', 'true');
        // (fallback for some older builds)
        localStorage.setItem('nav-sync', 'true');
    } catch(e) {
        /* storage unavailable? ignore */
    }
</script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
  $(function() { init_search(); });
/* @license-end */
</script>
<script type="text/javascript">
window.MathJax = {
  options: {
    ignoreHtmlClass: 'tex2jax_ignore',
    processHtmlClass: 'tex2jax_process'
  }
};
</script>
<script type="text/javascript" id="MathJax-script" async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome-sidebar-only-darkmode-toggle.css" rel="stylesheet" type="text/css"/>
<link href="custom.css" rel="stylesheet" type="text/css"/>
</head>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-93BB4673PE"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-93BB4673PE');
</script>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-3F0Y5Z6543"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-3F0Y5Z6543');
</script>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="5">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="Helios_logo_small.png"></td>
  <td id="projectalign">
   <div id="projectname">
       <span id="projectnumber">&#160;v1.3.37</span>
   </div>
  </td>
     <td id="searchbox-container">        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <span id="MSearchSelect"                onmouseover="return searchBox.OnSearchSelectShow()"                onmouseout="return searchBox.OnSearchSelectHide()">&#160;</span>
          <input type="text" id="MSearchField" value="" placeholder="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.svg" alt=""/></a>
          </span>
        </div>
</td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.13.2 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(0); });
/* @license-end */
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('canopy__w_u_e_tutorial.html',''); initResizable(true); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Tutorial 12: Water-use efficiency (photosyntheses per unit transpiration) for a canopy of spherical crowns</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>In this tutorial, we will combine several plugins in order to calculate the water use efficiency (WUE) of a plant canopy. We will calculate WUE at an hourly timestep, updating environmental and radiation inputs as we progress through the day.</p>
<h1><a class="anchor" id="tutorial12_plugins"></a>
1. Loading Plug-ins</h1>
<p>The first thing that we need to do is to specify the plugins that will be included in the simulation framework. For this example, we will use the CanopyGenerator, RadiationModel, EnergyBalanceModel, PhotosynthesisModel, StomatalConductanceModel, SolarPosition, and Visualizer plugins. Make sure that all of these plugins are all included in your CMakeLists.txt file under set( PLUGINS), and that they are also included at the top of your main.cpp file using the include command.</p>
<h1><a class="anchor" id="tutorial12_context"></a>
2. Defining the Context</h1>
<p>Now we will need to declare the Context of our simulation. We will also want to define several inputs that will remain constant through subsequent loops, including the date, latitude, longitude, and UTC offset. These values play an important role in determining the position of the sun in our SolarPosition plugin. We will also assign assumed values for atmospheric pressure and turbidity of the air, which will help us to define radiation fluxes later on. For the sake of this Tutorial, we will be assuming that our canopy is located in Davis, CA, and that our simulation takes place on 6/20/2024.</p>
<h1><a class="anchor" id="tutorial12_geometry"></a>
3. Creating Our Model Geometry</h1>
<p>Next, we will construct a canopy. In this tutorial we will use the CanopyGenerator plugin to create a canopy of ellipsoidal crowns composed of rectangular leaf elements. It is worth noting, however, that there are many ways to construct a canopy. For example, if you want to work with more complicated and/or realistic crowns, you can load in predefined geometries using .xml or .ply files, or you can use the PlantArchitecture model to generate crowns.</p>
<p>After initializing the plugin, we need to define a number of parameters which will define the geometry of our ellipsoidal crowns. The SphericalCrownsCanopyParameters parameter grouping inside of the canopy generator plugin requires a 3-input vector of float values to define the 3D (x, y, z) dimensions of our crowns using the crown_radius parameter. We will assume that the crowns each have a circular footprint, with the same x and y dimensions, so will define a single ‘radius’ value that will be used for both of these, but will define a different z dimension ‘height radius’ value. We also need to define the spacing between each of our crowns in both the x and y direction in a 2-input vector of float values using the plant_spacing parameter, so we will define a ‘row spacing’ value, as well as a ‘plant spacing’ value, which will correspond to the x and y dimensions, respectively. For the purposes of this tutorial, we will assume that crowns are immediately next to one another with no extra spacing between them. Since the spacing values are defined going from the center of one crown to the center of its neighbors, we will set these values equal to 2 times the crown radius values that we previously defined. However, if you wished to create greater spacing in either direction, you could easily do so by altering these values. Next, we need to determine the number of rows (in the x dimension) and number of plants per row ( in the y dimension) that we will simulate. For our purposes we will make a 3 x 3 grid of crowns, which will be input as a 2-input vector of integer values using the plant_count parameter. We will also define the size of our leaf elements using a 2-input vector of float values giving the length and width of our leaves using the leaf_size parameter, as well as the number of subdivisions that will be present on each leaf in order to give our models greater resolution in the x and y dimensions of each leaf primitive using a 2-input vector of integer values using the leaf_subdivisions parameter. Finally, we will also define the leaf area density of our crowns (e.g. the m2 leaf area per m3 crown volume).</p>
<p>We will then use the CanopyGenerator::buildCanopy() function with our parameter inputs to construct our 3x3 grid of ellipsoidal crowns. We will also need to define a vector containing all of our leaf UUIDs, with 1 unique UUID per leaf primitive that we have constructed. In order to do this, we can loop through each of the 9 crowns that we have created, and add all of their leaf UUIDs into a single vector.</p>
<p>We will also create a ground object, using the CanopyGenerator::buildGround() function. We need to define the ground’s origin (a vec3 3D locator, centered at 0,0,0 in this case), its size (a vec2 x/y extent indicator, which will have an x length = our row spacing multiplied by the number of rows that we have, and a y length = our plant spacing multiplied by the number of plants per row that we have), as well as a number of ground patches (which we will set equal to the number of crowns) and the number of subpatches that we will have on our ground object, each as a vec2 of integer values.</p>
<h1><a class="anchor" id="tutorial12_solarposition"></a>
4. Setting Up the Solar Position Model</h1>
<p>Now that we have defined our environmental conditions for the current hour, we can begin setting up the plugin models. We will start with the SolarPosition model. The position of the sun will automatically be determined when we initialize the plugin by calling the SolarPosition class with inputs of our predefined UTC offset, latitude, longitude, and a pointer to the context, which will call the time value which was set during the previous step.</p>
<p>We will also separate our total radiation flux out into three bands: 1) longwave (LW), which can be determined using the SolarPosition::getAmbientLongwaveFlux() function with inputs of air temperature and relative humidity, and 2) photosynthetically active radiation (PAR) and 3) near-infrared radiation (NIR), both of which can be determined with inputs of atmospheric pressure, air temperature, relative humidity, and turbidity using the SolarPosition::getSolarFluxPAR() and SolarPosition::getSolarFluxNIR() functions, respectively.</p>
<p>For these latter two bands, we will also calculate the fraction of incoming radiation which will come from diffuse environmental sources, rather than direct radiation from the sun source.</p>
<h1><a class="anchor" id="tutorial12_radiation"></a>
5. Setting Up the Radiation Model</h1>
<p>Now that we have the solar position and flux values for each of our radiation bands, we can initialize the RadiationModel class.</p>
<p>We will then create the sun source in our simulation using the solar position value that we determined in the previous step as a pointer in the RadiationModel::addsolar_positionSphereRadiationSource() function. We will also add in the three bands that we previously defined using RadiationModel::addRadiationBand(). For the PAR and NIR bands we will disable emission because terrestrial objects do not emit radiation in these bands. We will set the total flux coming from the sun and from diffuse radiation separately for these bands using RadiationModel::setSourceFlux() and RadiationModel::setDiffuseRadiationFlux(), respectively, and will use RadiationModel::setScatteringDepth() equal to 3 in order to track each ray through reflection and transmission after it has intercepted with 3 surfaces in the context geometry.</p>
<p>Next, we will call RadiationModel::enforcePeriodicBoundary("xy"), which will treat the context geometry as though it repeats infinitely in x and y dimensions (e.g. the canopy geometry that we created will be surrounded on all sides by an identical canopy). We will then set the radiation properties of the primitives in our geometry. We will set the reflectivity and transmissivity radiation in both PAR and NIR bands for leaf UUIDs. Ground UUIDs need only have reflectivity set, as they will not transmit light. We will also set the ground UUIDs “twosided_flag” to 0 because atmospheric radiation will only be intercepted on the top.</p>
<p>We will also call RadiationModel::updateGeometry() in order to make sure that the radiation model fully accounts for the primitive geometry that we have constructed in the context. Note that unless the geometry changes, we only need to call this once. This function is very computationally heavy, so calling it unnecessarily (such as within a loop) will make the code slow.</p>
<h1><a class="anchor" id="tutorial12_energybalance"></a>
6. Setting Up the Energy Balance Model</h1>
<p>Now we need to initialize the EnergyBalanceModel, and add each of the three radiation bands that we created in the previous steps using the EnergyBalanceModel::addRadiationBand() function.</p>
<h1><a class="anchor" id="tutorial12_gs"></a>
7.Setting Up the Stomatal Conductance Model</h1>
<p>Now we will initialize the stomatal conductance model plugin, which will allow us to define the way that stomatal conductance will vary with environmental inputs. There are a number of different models that we can choose from, as described in the documentation, but for our purposes we will use the Buckley, Mott, and Farquhar model by calling BMFcoefficients. This requires 4 parameter inputs, which vary with your species of interest. Here we will use the default parameter values, which are fitted to almond stomatal conductance measurements.</p>
<h1><a class="anchor" id="tutorial12_photosynthesis"></a>
8. Setting Up the Photosynthesis Model</h1>
<p>Finally, we need to initialize the photosynthesis model plugin, which will allow us to find the carbon assimilated during each timestep in our simulation. Again, there are a number of different models that can be chosen from, but we will use the Farquhar model in this instance.</p>
<h1><a class="anchor" id="tutorial12_timeseries"></a>
9. Reading in Our Timeseries Data</h1>
<p>Now we need to define the environmental conditions present in the canopy at each hour. We will use an .xml file with air temperature, relative humidity, and windspeed data pulled from the Davis CIMIS station.</p>
<p>We will be calculating WUE during each hour in the day and will need to run all of our plugins iteratively during each hour, so we will now set up a for-loop to iterate through the day at an hourly timestep.</p>
<p>Next, during each hour within the for-loop, we will set the time within the context of our simulation and will query our .xml file to find the air temperature, relative humidity, and windspeed.</p>
<h1><a class="anchor" id="tutorial12_run"></a>
10. Running the Model Calculations</h1>
<p>Now that all of the plugins have been set up, we can run the models. We will start by running each of our three radiation bands using RadiationModel::runBand(). Next, we can run the stomatal conductance plugin using StomatalConductanceModel::run() for all of our leaf UUIDs, followed by running the energy balance plugin using EnergyBalanceModel::run(). It should be noted at this point that the stomatal conductance and energy balance plugins will be run using the default primitive temperature values, so we should re-run our longwave band, the stomatal conductance model, and the energy balance model in order to get more accurate temperature values updated based on the environmental data and its interactions with latent heat from transpiration and the overall energy balance. This could be done several times if desired, but we will only repeat once for our purposes here.</p>
<p>Finally, we can run the photosynthesis plugin using PhotosynthesisModel::run() for all of our leaf UUIDs.</p>
<h1><a class="anchor" id="tutorial12_WUE"></a>
11. Calculating WUE</h1>
<p>Now that we have run all of our plugins, we can recover our outputs for the timestep. For water use efficiency, we will need to get an overall transpiration value canopy as well as an overall carbon assimilation value. In order to do so, we can loop over each of the leaf UUIDs in our context and retrieve ‘latent flux’ and ‘net photosynthesis’ values for each primitive using context::getPrimitiveData(). We can find the overall canopy values for each by multiplying each leaf’s value by the leaf area and then summing all of the leaves’ values together. To convert our retrieved latent flux value from W/m2 to mol H2O / second we can divide the latent flux by 44000, and then can multiply that value by 1000 to get mmol H2O / second. We can also calculate WUE for individual leaf elements by dividing our leaf primitive assimilation rate by our leaf primitive transpiration rate in order to get the WUE in μmol CO2 / mmol H2O. We can assign this value as new primitive data for each of the leaf elements using context::setPrimitiveData() so that we can make a visualization showing variation of WUE throughout the canopy later on.</p>
<p>Once we have completed our loop, we can divide our overall canopy assimilation rate by our canopy transpiration rate in order to get the WUE in μmol CO2 / mmol H2O. This will give us the overall canopy WUE for each hour.</p>
<h1><a class="anchor" id="tutorial12_visualization"></a>
12. Visualization</h1>
<p>We can wrap up by creating an hourly visualization that will show the 3D variation of WUE throughout our canopy using the visualizer plugin. After initializing the plugin, we just need to set the Visualizer::setContextPrimitivesByData() function to the WUE primitive data that we assigned during the previous step.</p>
<h1><a class="anchor" id="tutorial12_code"></a>
Code</h1>
<p>The code below gives a full example of the above steps. Note that this code requires the input XML file '6_20_2024_CIMIS.xml'. The code below assumes that it is located in a sub-folder of the project directory called 'xml'. Modify the code as needed depending on where you place the file. It can be downloaded here: <a href="https://baileylab.ucdavis.edu/software/tutorialfiles/6_20_2024_CIMIS.xml">right-click and select "Download Linked File" or "Save As"</a>.</p>
<div class="fragment"><div class="line"><span class="comment">// *** Step 1: Loading Plugins *** //</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="_canopy_generator_8h.html">CanopyGenerator.h</a>&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="_radiation_model_8h.html">RadiationModel.h</a>&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="_energy_balance_model_8h.html">EnergyBalanceModel.h</a>&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="_photosynthesis_model_8h.html">PhotosynthesisModel.h</a>&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="_stomatal_conductance_model_8h.html">StomatalConductanceModel.h</a>&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="_solar_position_8h.html">SolarPosition.h</a>&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="_boundary_layer_conductance_model_8h.html">BoundaryLayerConductanceModel.h</a>&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="_visualizer_8h.html">Visualizer.h</a>&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">using namespace </span>helios;</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span> main() {</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// *** Step 2: Defining the Context *** //</span></div>
<div class="line"> </div>
<div class="line">    <a class="code hl_class" href="classhelios_1_1_context.html" title="Stores the state associated with simulation.">Context</a> context;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">//Set Date</span></div>
<div class="line">    <a class="code hl_struct" href="structhelios_1_1_date.html" title="Date vector.">Date</a> date(20, 6, 2024);</div>
<div class="line">    context.<a class="code hl_function" href="classhelios_1_1_context.html#a5b9565e477a321ec7b7b9b62d43b2139" title="Set simulation date by day, month, year.">setDate</a>(date);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">//Define location and timezone</span></div>
<div class="line">    <span class="keywordtype">float</span> latitude = 38.535694;</div>
<div class="line">    <span class="keywordtype">float</span> longitude = 121.776360;</div>
<div class="line">    <span class="keywordtype">int</span> UTC = 7;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">//Atmospheric Constants</span></div>
<div class="line">    <span class="keywordtype">float</span> pressure = 101300; <span class="comment">//Atmospheric Pressure, Pa</span></div>
<div class="line">    <span class="keywordtype">float</span> turbidity = 0.05;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// *** Step 3: Creating Our Model Geometry *** //</span></div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Build the Canopy //</span></div>
<div class="line">    <a class="code hl_class" href="class_canopy_generator.html">CanopyGenerator</a> canopygenerator(&amp;context);</div>
<div class="line"> </div>
<div class="line">    std::vector&lt;uint&gt; leaf_UUIDs;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">float</span> crown_radius = 1.5; <span class="comment">//meters</span></div>
<div class="line">    <span class="keywordtype">float</span> crown_height_radius = 3.; <span class="comment">//meters</span></div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">float</span> spacing_row = 2 * crown_radius;</div>
<div class="line">    <span class="keywordtype">float</span> spacing_plant = 2 * crown_radius;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">int</span> row_number = 3; <span class="comment">//number of rows</span></div>
<div class="line">    <span class="keywordtype">int</span> plant_number = 3; <span class="comment">//number of plants per row</span></div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">float</span> l_leaf = 0.075; <span class="comment">//leaf length</span></div>
<div class="line">    <span class="keywordtype">float</span> w_leaf = 0.05; <span class="comment">//leaf width</span></div>
<div class="line"> </div>
<div class="line">    <span class="comment">//Leaf and canopy parameters</span></div>
<div class="line">    <a class="code hl_struct" href="struct_spherical_crowns_canopy_parameters.html" title="Parameters defining the canopy with spherical crowns.">SphericalCrownsCanopyParameters</a> params;</div>
<div class="line">    params.<a class="code hl_variable" href="struct_spherical_crowns_canopy_parameters.html#a1695b7794ffb1c8ab8618ebb701fbb6d" title="Radius of the spherical crowns.">crown_radius</a> = <a class="code hl_function" href="helios__vector__types_8h.html#acff34a9c833707c7aef9618cd19265c5" title="Make a vec3 from three floats.">make_vec3</a>(crown_radius, crown_radius, crown_height_radius);</div>
<div class="line">    params.<a class="code hl_variable" href="struct_spherical_crowns_canopy_parameters.html#a9be21b26afb7d32b61a236bbe5372acd" title="Spacing between adjacent crowns in the x- and y-directions. Note that if canopy_configuration=&#39;random...">plant_spacing</a> = <a class="code hl_function" href="group__vectors.html#ga2c8ce4551d0597a3aaaf32530233c6fd" title="Make a vec2 from two floats.">make_vec2</a>(spacing_row, spacing_plant);</div>
<div class="line">    params.<a class="code hl_variable" href="struct_spherical_crowns_canopy_parameters.html#a8ac3d5fbeee86db6289693aa5e14a76f" title="Number of crowns/plants in the x- and y-directions.">plant_count</a> = <a class="code hl_function" href="group__vectors.html#ga70f2d62c3dfc6bbff6581cbc0f8bacee" title="Make an int2 vector from two ints.">make_int2</a>(row_number, plant_number);</div>
<div class="line">    params.<a class="code hl_variable" href="struct_spherical_crowns_canopy_parameters.html#a48c2ab4110bc38b4f412250d8e3e8051" title="Length of leaf in x- and y- directions (prior to rotation)">leaf_size</a> = <a class="code hl_function" href="group__vectors.html#ga2c8ce4551d0597a3aaaf32530233c6fd" title="Make a vec2 from two floats.">make_vec2</a>(l_leaf, w_leaf);</div>
<div class="line">    params.<a class="code hl_variable" href="struct_spherical_crowns_canopy_parameters.html#aa7ddee04ae15e0aa0814702a0ef4a034" title="Number of sub-division segments per leaf.">leaf_subdivisions</a> = <a class="code hl_function" href="group__vectors.html#ga70f2d62c3dfc6bbff6581cbc0f8bacee" title="Make an int2 vector from two ints.">make_int2</a>(3, 3);</div>
<div class="line">    params.<a class="code hl_variable" href="struct_spherical_crowns_canopy_parameters.html#ab625b07dbc7f73b11d4af2932e96158d" title="One-sided leaf area density within spherical crowns.">leaf_area_density</a> = 1.f;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">//Create the crowns</span></div>
<div class="line">    canopygenerator.buildCanopy(params);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">//Get the UUID numbers for all of the leaves</span></div>
<div class="line">    leaf_UUIDs = canopygenerator.getLeafUUIDs();</div>
<div class="line"> </div>
<div class="line">    <span class="comment">//ground parameters</span></div>
<div class="line">    <span class="keywordtype">float</span> x_ground = spacing_row*row_number;</div>
<div class="line">    <span class="keywordtype">float</span> y_ground = spacing_plant*plant_number;</div>
<div class="line">    <a class="code hl_struct" href="structhelios_1_1vec2.html" title="Vector of two elements of type &#39;float&#39;.">vec2</a> size_ground = <a class="code hl_function" href="group__vectors.html#ga2c8ce4551d0597a3aaaf32530233c6fd" title="Make a vec2 from two floats.">make_vec2</a>(x_ground, y_ground);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">//Make the Ground</span></div>
<div class="line">    canopygenerator.buildGround(<a class="code hl_function" href="helios__vector__types_8h.html#acff34a9c833707c7aef9618cd19265c5" title="Make a vec3 from three floats.">make_vec3</a>(0,0,0), size_ground, <a class="code hl_function" href="group__vectors.html#ga70f2d62c3dfc6bbff6581cbc0f8bacee" title="Make an int2 vector from two ints.">make_int2</a>(row_number,plant_number), <a class="code hl_function" href="group__vectors.html#ga70f2d62c3dfc6bbff6581cbc0f8bacee" title="Make an int2 vector from two ints.">make_int2</a>(3,3), <span class="stringliteral">&quot;plugins/canopygenerator/textures/dirt.jpg&quot;</span>);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">//Ground UUIDs</span></div>
<div class="line">    std::vector&lt;uint&gt; ground_UUIDs = canopygenerator.getGroundUUIDs();</div>
<div class="line">    <span class="comment">//UUIDs of all primitives in the context</span></div>
<div class="line">    std::vector&lt;uint&gt; all_UUIDs = context.<a class="code hl_function" href="classhelios_1_1_context.html#a98516632daccf958cca6b5b6582310bb" title="Get all primitive UUIDs currently in the Context.">getAllUUIDs</a>();</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// *** Step 4: Setting Up the Solar Position Model *** //</span></div>
<div class="line"> </div>
<div class="line">    <a class="code hl_class" href="class_solar_position.html">SolarPosition</a> solar_position(UTC, latitude, longitude, &amp;context);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// *** Step 5: Setting Up the Radiation Model *** //</span></div>
<div class="line">    <a class="code hl_class" href="class_radiation_model.html" title="Radiation transport model plugin.">RadiationModel</a> radiation(&amp;context);</div>
<div class="line"> </div>
<div class="line">    <a class="code hl_typedef" href="global_8h.html#a91ad9478d81a7aaf2593e8d9c3d06a14" title="Unsigned integer type.">uint</a> SunSource = radiation.addSunSphereRadiationSource();</div>
<div class="line"> </div>
<div class="line">    radiation.addRadiationBand(<span class="stringliteral">&quot;PAR&quot;</span>);</div>
<div class="line">    radiation.disableEmission(<span class="stringliteral">&quot;PAR&quot;</span>);</div>
<div class="line">    radiation.setScatteringDepth(<span class="stringliteral">&quot;PAR&quot;</span>, 3);</div>
<div class="line"> </div>
<div class="line">    radiation.addRadiationBand(<span class="stringliteral">&quot;NIR&quot;</span>);</div>
<div class="line">    radiation.disableEmission(<span class="stringliteral">&quot;NIR&quot;</span>);</div>
<div class="line">    radiation.setScatteringDepth(<span class="stringliteral">&quot;NIR&quot;</span>, 3);</div>
<div class="line"> </div>
<div class="line">    radiation.addRadiationBand(<span class="stringliteral">&quot;LW&quot;</span>);</div>
<div class="line"> </div>
<div class="line">    radiation.enforcePeriodicBoundary(<span class="stringliteral">&quot;xy&quot;</span>);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">//Set leaf radiative properties</span></div>
<div class="line">    context.<a class="code hl_function" href="classhelios_1_1_context.html#a817fe7d1b8a11f51923d3a7e2c3ba092" title="Add data value (int) associated with a primitive element.">setPrimitiveData</a>(leaf_UUIDs, <span class="stringliteral">&quot;reflectivity_PAR&quot;</span>, 0.10f);</div>
<div class="line">    context.<a class="code hl_function" href="classhelios_1_1_context.html#a817fe7d1b8a11f51923d3a7e2c3ba092" title="Add data value (int) associated with a primitive element.">setPrimitiveData</a>(leaf_UUIDs, <span class="stringliteral">&quot;transmissivity_PAR&quot;</span>, 0.05f);</div>
<div class="line">    context.<a class="code hl_function" href="classhelios_1_1_context.html#a817fe7d1b8a11f51923d3a7e2c3ba092" title="Add data value (int) associated with a primitive element.">setPrimitiveData</a>(leaf_UUIDs, <span class="stringliteral">&quot;reflectivity_NIR&quot;</span>, 0.45f);</div>
<div class="line">    context.<a class="code hl_function" href="classhelios_1_1_context.html#a817fe7d1b8a11f51923d3a7e2c3ba092" title="Add data value (int) associated with a primitive element.">setPrimitiveData</a>(leaf_UUIDs, <span class="stringliteral">&quot;transmissivity_NIR&quot;</span>, 0.4f);</div>
<div class="line"> </div>
<div class="line">    context.<a class="code hl_function" href="classhelios_1_1_context.html#a817fe7d1b8a11f51923d3a7e2c3ba092" title="Add data value (int) associated with a primitive element.">setPrimitiveData</a>(ground_UUIDs, <span class="stringliteral">&quot;reflectivity_PAR&quot;</span>, 0.15f);</div>
<div class="line">    context.<a class="code hl_function" href="classhelios_1_1_context.html#a817fe7d1b8a11f51923d3a7e2c3ba092" title="Add data value (int) associated with a primitive element.">setPrimitiveData</a>(ground_UUIDs, <span class="stringliteral">&quot;reflectivity_NIR&quot;</span>, 0.4f);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">//Make sure that the ground is only able to intercept radiation from the top</span></div>
<div class="line">    context.<a class="code hl_function" href="classhelios_1_1_context.html#a817fe7d1b8a11f51923d3a7e2c3ba092" title="Add data value (int) associated with a primitive element.">setPrimitiveData</a>(ground_UUIDs, <span class="stringliteral">&quot;twosided_flag&quot;</span>, <a class="code hl_typedef" href="global_8h.html#a91ad9478d81a7aaf2593e8d9c3d06a14" title="Unsigned integer type.">uint</a>(0));</div>
<div class="line"> </div>
<div class="line">    radiation.updateGeometry();</div>
<div class="line"> </div>
<div class="line">    <span class="comment">//*** Step 6: Setting Up the Energy Balance Model ***//</span></div>
<div class="line"> </div>
<div class="line">    <a class="code hl_class" href="class_energy_balance_model.html" title="Energy balance model class.">EnergyBalanceModel</a> energybalance(&amp;context);</div>
<div class="line"> </div>
<div class="line">    energybalance.addRadiationBand(<span class="stringliteral">&quot;PAR&quot;</span>);</div>
<div class="line">    energybalance.addRadiationBand(<span class="stringliteral">&quot;NIR&quot;</span>);</div>
<div class="line">    energybalance.addRadiationBand(<span class="stringliteral">&quot;LW&quot;</span>);</div>
<div class="line"> </div>
<div class="line">    <a class="code hl_class" href="class_b_l_conductance_model.html" title="Boundary-layer conductance model class.">BLConductanceModel</a> boundarylayerconductance(&amp;context);</div>
<div class="line"> </div>
<div class="line">    boundarylayerconductance.setBoundaryLayerModel( ground_UUIDs, <span class="stringliteral">&quot;Ground&quot;</span> );</div>
<div class="line">    boundarylayerconductance.setBoundaryLayerModel( leaf_UUIDs, <span class="stringliteral">&quot;Pohlhausen&quot;</span> );</div>
<div class="line"> </div>
<div class="line">    <span class="comment">//*** Step 7: Setting Up the Stomatal Conductance Model ***//</span></div>
<div class="line"> </div>
<div class="line">    <a class="code hl_class" href="class_stomatal_conductance_model.html">StomatalConductanceModel</a> stomatalconductance(&amp;context);</div>
<div class="line"> </div>
<div class="line">    <a class="code hl_struct" href="struct_b_m_fcoefficients.html" title="Coefficients for simplified Buckley, Mott, &amp; Farquhar stomatal conductance model.">BMFcoefficients</a> bmfc;</div>
<div class="line">    stomatalconductance.setModelCoefficients(bmfc);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">//*** Step 8: Setting Up Photosynthesis Model ***//</span></div>
<div class="line"> </div>
<div class="line">    <a class="code hl_class" href="class_photosynthesis_model.html">PhotosynthesisModel</a> photosynthesis(&amp;context);</div>
<div class="line"> </div>
<div class="line">    <a class="code hl_struct" href="struct_farquhar_model_coefficients.html">FarquharModelCoefficients</a> photoparams;</div>
<div class="line">    photosynthesis.setModelCoefficients(photoparams);</div>
<div class="line">    photosynthesis.setModelType_Farquhar();</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// *** Step 9: Reading in Our Timeseries Data *** //</span></div>
<div class="line"> </div>
<div class="line">    context.<a class="code hl_function" href="classhelios_1_1_context.html#a129516a8fce035705a541e7b877eba2f" title="Load inputs specified in an XML file.">loadXML</a>(<span class="stringliteral">&quot;../xml/6_20_2024_CIMIS.xml&quot;</span>);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span>( <span class="keywordtype">int</span> hour = 7; hour&lt;18; hour++){</div>
<div class="line"> </div>
<div class="line">        <a class="code hl_struct" href="structhelios_1_1_time.html" title="Time vector.">Time</a> time(hour, 0, 0);</div>
<div class="line">        context.<a class="code hl_function" href="classhelios_1_1_context.html#ae3d9e19581787775556b8dd7dc1ac845" title="Set simulation time.">setTime</a>(time);</div>
<div class="line"> </div>
<div class="line">        <span class="comment">// this will query these timseries variables based on the date and time set in the Context</span></div>
<div class="line">        <span class="keywordtype">float</span> air_temperature = context.<a class="code hl_function" href="group__timeseries.html#ga8845155a8f5df1e6db968b78f5a5fb18" title="Get a timeseries data point by specifying a date and time vector.">queryTimeseriesData</a>(<span class="stringliteral">&quot;air_temperature&quot;</span>); <span class="comment">// degrees C</span></div>
<div class="line">        <span class="keywordtype">float</span> air_humidity = context.<a class="code hl_function" href="group__timeseries.html#ga8845155a8f5df1e6db968b78f5a5fb18" title="Get a timeseries data point by specifying a date and time vector.">queryTimeseriesData</a>(<span class="stringliteral">&quot;humidity&quot;</span>); <span class="comment">// Percent</span></div>
<div class="line">        <span class="keywordtype">float</span> wind_speed = context.<a class="code hl_function" href="group__timeseries.html#ga8845155a8f5df1e6db968b78f5a5fb18" title="Get a timeseries data point by specifying a date and time vector.">queryTimeseriesData</a>(<span class="stringliteral">&quot;wind_speed&quot;</span>); <span class="comment">// m/s</span></div>
<div class="line"> </div>
<div class="line">        <span class="comment">// update our primitive data values on each timestep based on timeseries data</span></div>
<div class="line">        context.<a class="code hl_function" href="classhelios_1_1_context.html#a817fe7d1b8a11f51923d3a7e2c3ba092" title="Add data value (int) associated with a primitive element.">setPrimitiveData</a>(all_UUIDs, <span class="stringliteral">&quot;air_temperature&quot;</span>, air_temperature);</div>
<div class="line">        context.<a class="code hl_function" href="classhelios_1_1_context.html#a817fe7d1b8a11f51923d3a7e2c3ba092" title="Add data value (int) associated with a primitive element.">setPrimitiveData</a>(all_UUIDs, <span class="stringliteral">&quot;air_humidity&quot;</span>, air_humidity);</div>
<div class="line">        context.<a class="code hl_function" href="classhelios_1_1_context.html#a817fe7d1b8a11f51923d3a7e2c3ba092" title="Add data value (int) associated with a primitive element.">setPrimitiveData</a>(all_UUIDs, <span class="stringliteral">&quot;wind_speed&quot;</span>, wind_speed);</div>
<div class="line"> </div>
<div class="line">        <span class="keywordtype">float</span> LW = solar_position.getAmbientLongwaveFlux(air_temperature, air_humidity);</div>
<div class="line">        <span class="keywordtype">float</span> PAR = solar_position.getSolarFluxPAR(pressure, air_temperature, air_humidity, turbidity);</div>
<div class="line">        <span class="keywordtype">float</span> NIR = solar_position.getSolarFluxNIR(pressure, air_temperature, air_humidity, turbidity);</div>
<div class="line">        <span class="keywordtype">float</span> f_diff = solar_position.getDiffuseFraction(pressure, air_temperature, air_humidity, turbidity);</div>
<div class="line"> </div>
<div class="line">        radiation.setSourceFlux(SunSource, <span class="stringliteral">&quot;NIR&quot;</span>, NIR * (1.f - f_diff));</div>
<div class="line">        radiation.setDiffuseRadiationFlux(<span class="stringliteral">&quot;NIR&quot;</span>, NIR * f_diff);</div>
<div class="line">        radiation.setSourceFlux(SunSource, <span class="stringliteral">&quot;PAR&quot;</span>, PAR * (1.f - f_diff));</div>
<div class="line">        radiation.setDiffuseRadiationFlux(<span class="stringliteral">&quot;PAR&quot;</span>, PAR * f_diff);</div>
<div class="line">        radiation.setDiffuseRadiationFlux(<span class="stringliteral">&quot;LW&quot;</span>, LW);</div>
<div class="line"> </div>
<div class="line">        radiation.setSourcePosition( SunSource, solar_position.getSunDirectionVector() );</div>
<div class="line"> </div>
<div class="line">        boundarylayerconductance.run();</div>
<div class="line"> </div>
<div class="line">        <span class="comment">// *** Step 10: Running the Model *** //</span></div>
<div class="line"> </div>
<div class="line">        radiation.runBand({<span class="stringliteral">&quot;PAR&quot;</span>,<span class="stringliteral">&quot;NIR&quot;</span>,<span class="stringliteral">&quot;LW&quot;</span>});</div>
<div class="line"> </div>
<div class="line">        stomatalconductance.run(leaf_UUIDs);</div>
<div class="line">        energybalance.run();</div>
<div class="line"> </div>
<div class="line">        <span class="comment">//Run the longwave band, stomatal conductance plugin, and energy balance plugin again to update primitive temperature values</span></div>
<div class="line">        radiation.runBand(<span class="stringliteral">&quot;LW&quot;</span>);</div>
<div class="line">        stomatalconductance.run(leaf_UUIDs);</div>
<div class="line">        energybalance.run();</div>
<div class="line"> </div>
<div class="line">        photosynthesis.run(leaf_UUIDs); <span class="comment">// always run this last, since nothing depends on it</span></div>
<div class="line"> </div>
<div class="line">        <span class="comment">// *** Step 11: Calculating WUE ***//</span></div>
<div class="line"> </div>
<div class="line">        <span class="keywordtype">float</span> A_canopy = 0;</div>
<div class="line">        <span class="keywordtype">float</span> E_canopy = 0;</div>
<div class="line">        <span class="keywordflow">for</span> (<a class="code hl_typedef" href="global_8h.html#a91ad9478d81a7aaf2593e8d9c3d06a14" title="Unsigned integer type.">uint</a> UUID : leaf_UUIDs) {</div>
<div class="line">            <span class="keywordtype">float</span> E, A, WUE;</div>
<div class="line">            context.<a class="code hl_function" href="classhelios_1_1_context.html#a2144eea981e4030c973287ce2c38315e" title="Get data associated with a primitive element.">getPrimitiveData</a>(UUID, <span class="stringliteral">&quot;latent_flux&quot;</span>, E);</div>
<div class="line">            context.<a class="code hl_function" href="classhelios_1_1_context.html#a2144eea981e4030c973287ce2c38315e" title="Get data associated with a primitive element.">getPrimitiveData</a>(UUID, <span class="stringliteral">&quot;net_photosynthesis&quot;</span>, A);</div>
<div class="line">            E_canopy += E / 44000 * 1000; <span class="comment">// mmol H2O / m^2 / sec</span></div>
<div class="line">            A_canopy += A;  <span class="comment">//umol CO2 / m^2 / sec</span></div>
<div class="line"> </div>
<div class="line">            WUE = A / (E / 44000 * 1000); <span class="comment">//umol CO2/mmol H2O</span></div>
<div class="line">            context.<a class="code hl_function" href="classhelios_1_1_context.html#a817fe7d1b8a11f51923d3a7e2c3ba092" title="Add data value (int) associated with a primitive element.">setPrimitiveData</a>(UUID, <span class="stringliteral">&quot;WUE&quot;</span>, WUE);</div>
<div class="line"> </div>
<div class="line">        }</div>
<div class="line">        <span class="keywordtype">float</span> WUE_canopy = A_canopy / E_canopy; <span class="comment">//umol CO2/mmol H2O</span></div>
<div class="line"> </div>
<div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;WUE of the canopy = &quot;</span> &lt;&lt; WUE_canopy &lt;&lt; <span class="stringliteral">&quot; umol CO2/mmol H2O&quot;</span> &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">        <span class="comment">// *** Step 12: Visualization *** //</span></div>
<div class="line">        <span class="comment">// This will open the visualizer window for each time step. Close it to proceed to the next time step.</span></div>
<div class="line">        <a class="code hl_class" href="class_visualizer.html" title="Class for visualization of simulation results.">Visualizer</a> visualizer(1000);</div>
<div class="line">        visualizer.buildContextGeometry(&amp;context);</div>
<div class="line">        visualizer.colorContextPrimitivesByData( <span class="stringliteral">&quot;WUE&quot;</span> );</div>
<div class="line">        visualizer.setColorbarTitle(<span class="stringliteral">&quot;WUE (umol CO2/mmol H2O)&quot;</span>);;</div>
<div class="line">        visualizer.setColorbarRange(0.f,15.f);</div>
<div class="line">        visualizer.setColorbarPosition(<a class="code hl_function" href="helios__vector__types_8h.html#acff34a9c833707c7aef9618cd19265c5" title="Make a vec3 from three floats.">make_vec3</a>(0.75, 0.9, 0) );</div>
<div class="line">        <span class="keywordtype">char</span> time_string[6];</div>
<div class="line">        sprintf(time_string, <span class="stringliteral">&quot;%02d:%02d&quot;</span>, time.hour, time.minute);</div>
<div class="line">        visualizer.addTextboxByCenter( time_string, <a class="code hl_function" href="helios__vector__types_8h.html#acff34a9c833707c7aef9618cd19265c5" title="Make a vec3 from three floats.">make_vec3</a>(0.5,0.9,0), <a class="code hl_variable" href="global_8h.html#adcd5a98ec7c45292736ec8e19ce9de51" title="Default null SphericalCoord that applies no rotation.">nullrotation</a>, RGB::black, 16, <span class="stringliteral">&quot;Arial&quot;</span>, <a class="code hl_enumvalue" href="class_visualizer.html#a084713b3d4d0720dcc1ee44d270b42e3a9392af82f887f2fc1982a8315bcc95f5" title="Coordinates are normalized to unity and are window-aligned. The point (x,y)=(0,0) is in the bottom le...">Visualizer::COORDINATES_WINDOW_NORMALIZED</a> );</div>
<div class="line">        visualizer.plotInteractive(); <span class="comment">// !!! Close the window to advance to the next time step</span></div>
<div class="line"> </div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
</div><!-- fragment --> </div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.13.2 </li>
  </ul>
</div>
</body>
</html>
